<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת כניסה ורישום מקומית</title>
    <!-- טעינת Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* הגדרת פונט 'Inter' כברירת מחדל */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="auth-container" class="w-full max-w-md bg-white p-8 md:p-10 shadow-2xl rounded-xl border border-gray-100">

        <!-- כותרת האפליקציה -->
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2 text-center">
            כניסה
        </h1>
        <p class="text-gray-500 mb-8 text-center">
            השתמש במשתמשים השמורים באופן מקומי בדפדפן
        </p>

        <!-- הודעות מערכת -->
        <div id="message-box" class="mb-4 p-3 rounded-lg text-sm hidden" role="alert"></div>

        <!-- טופס כניסה / רישום -->
        <form id="auth-form" class="space-y-6">

            <!-- שדה שם משתמש -->
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700">שם משתמש</label>
                <input type="text" id="username" required 
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-right" 
                       placeholder="הזן שם משתמש">
            </div>

            <!-- שדה סיסמה -->
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">סיסמה</label>
                <input type="password" id="password" required 
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-right" 
                       placeholder="הזן סיסמה">
            </div>

            <!-- כפתור ראשי -->
            <div>
                <button type="submit" id="main-button" 
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    התחבר
                </button>
            </div>
        </form>

        <!-- מעבר בין מצבי רישום/כניסה -->
        <div class="mt-6 text-center">
            <button id="switch-mode-button" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium transition duration-150 ease-in-out">
                עדיין אין לך חשבון? הירשם
            </button>
        </div>
    </div>

    <!-- ממשק לאחר כניסה (Dashboard) -->
    <div id="dashboard" class="w-full max-w-md bg-white p-8 md:p-10 shadow-2xl rounded-xl border border-gray-100 hidden">
        <h2 class="text-3xl font-extrabold text-gray-900 mb-4 text-center">
            ברוך הבא!
        </h2>
        <p class="text-gray-600 text-center mb-8">
            נכנסת בהצלחה למערכת המקומית.
        </p>
        
        <div class="bg-indigo-50 p-4 rounded-lg">
             <p class="text-lg font-semibold text-indigo-700 mb-2">פרטי המשתמש הנוכחי:</p>
             <p class="text-gray-800">שם משתמש: <span id="current-username" class="font-bold"></span></p>
             <p class="text-sm text-gray-500 mt-2">הנתונים שלך נשמרים ב-`localStorage` בדפדפן זה.</p>
        </div>

        <button id="logout-button" 
                class="mt-8 w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
            יציאה (Logout)
        </button>
    </div>

    <script>
        // הגדרת משתנים גלובליים
        let users = [];
        let isRegisterMode = false;
        let loggedInUser = null;

        // קבועים
        const USERS_STORAGE_KEY = 'local_auth_users';
        const SESSION_STORAGE_KEY = 'local_auth_session';

        // אלמנטים מה-DOM
        const authContainer = document.getElementById('auth-container');
        const dashboard = document.getElementById('dashboard');
        const authForm = document.getElementById('auth-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const mainButton = document.getElementById('main-button');
        const switchModeButton = document.getElementById('switch-mode-button');
        const logoutButton = document.getElementById('logout-button');
        const messageBox = document.getElementById('message-box');
        const currentUsernameSpan = document.getElementById('current-username');
        
        // --- פונקציות עזר ל-localStorage ---

        /**
         * טוען את רשימת המשתמשים מה-localStorage.
         */
        function loadUsers() {
            const usersJson = localStorage.getItem(USERS_STORAGE_KEY);
            try {
                users = usersJson ? JSON.parse(usersJson) : [];
            } catch (e) {
                console.error("שגיאה בטעינת משתמשים: ", e);
                users = []; // איפוס במקרה של שגיאת JSON
            }
            // Logging: הראה את רשימת המשתמשים שהתקבלה
            console.log("משתמשים שנטענו:", users);
        }

        /**
         * שומר את רשימת המשתמשים המעודכנת ל-localStorage.
         */
        function saveUsers() {
            localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
        }

        /**
         * מציג הודעת מערכת למשתמש.
         * @param {string} message - ההודעה להצגה.
         * @param {string} type - סוג ההודעה ('success', 'error', 'info').
         */
        function displayMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = "mb-4 p-3 rounded-lg text-sm"; // איפוס
            
            let classes = "hidden";
            switch (type) {
                case 'success':
                    classes = "bg-green-100 border border-green-400 text-green-700";
                    break;
                case 'error':
                    classes = "bg-red-100 border border-red-400 text-red-700";
                    break;
                case 'info':
                default:
                    classes = "bg-blue-100 border border-blue-400 text-blue-700";
                    break;
            }
            messageBox.classList.add(...classes.split(' '));
        }

        // --- לוגיקת כניסה ורישום ---

        /**
         * מחליף בין מצב כניסה (Login) למצב רישום (Register).
         */
        function toggleMode() {
            isRegisterMode = !isRegisterMode;

            if (isRegisterMode) {
                mainButton.textContent = "הרשם";
                switchModeButton.textContent = "כבר יש לך חשבון? התחבר";
                document.querySelector('h1').textContent = "רישום";
            } else {
                mainButton.textContent = "התחבר";
                switchModeButton.textContent = "עדיין אין לך חשבון? הירשם";
                document.querySelector('h1').textContent = "כניסה";
            }
            // נקה הודעות ושדות
            messageBox.classList.add('hidden');
            usernameInput.value = '';
            passwordInput.value = '';
        }

        /**
         * מטפל בתהליך הרישום.
         * @param {string} username - שם המשתמש.
         * @param {string} password - הסיסמה.
         */
        function handleRegister(username, password) {
            // בדיקה האם המשתמש כבר קיים
            const existingUser = users.find(u => u.username === username);
            if (existingUser) {
                displayMessage('שם משתמש זה כבר קיים. אנא בחר שם אחר.', 'error');
                return;
            }

            // הוספת משתמש חדש
            users.push({ username, password }); // הסיסמה נשמרת כטקסט רגיל!
            saveUsers();
            
            // מעבר אוטומטי למצב כניסה
            displayMessage('הרישום בוצע בהצלחה! אנא התחבר.', 'success');
            toggleMode();
        }

        /**
         * מטפל בתהליך הכניסה.
         * @param {string} username - שם המשתמש.
         * @param {string} password - הסיסמה.
         */
        function handleLogin(username, password) {
            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                // כניסה מוצלחת
                loggedInUser = username;
                localStorage.setItem(SESSION_STORAGE_KEY, username);
                displayMessage('התחברת בהצלחה!', 'success');
                renderView();
            } else {
                // כניסה נכשלה
                displayMessage('שם משתמש או סיסמה שגויים.', 'error');
            }
        }

        /**
         * מטפל ביציאה מהמערכת.
         */
        function handleLogout() {
            loggedInUser = null;
            localStorage.removeItem(SESSION_STORAGE_KEY);
            displayMessage('יצאת מהמערכת.', 'info');
            renderView();
        }

        // --- ניהול תצוגה ---

        /**
         * מחליף את התצוגה בין טופס הכניסה/רישום ללוח הבקרה (Dashboard).
         */
        function renderView() {
            // הסתרת כל האלמנטים
            authContainer.classList.add('hidden');
            dashboard.classList.add('hidden');
            messageBox.classList.add('hidden');

            if (loggedInUser) {
                // הצג לוח בקרה
                dashboard.classList.remove('hidden');
                currentUsernameSpan.textContent = loggedInUser;
            } else {
                // הצג טופס אימות
                authContainer.classList.remove('hidden');
                authForm.reset();
            }
        }

        // --- אתחול והפעלת אירועים ---

        /**
         * טוען נתונים ומאתחל את האפליקציה.
         */
        function init() {
            // 1. טעינת נתוני המשתמשים
            loadUsers();

            // 2. בדיקת סשן קיים
            loggedInUser = localStorage.getItem(SESSION_STORAGE_KEY);

            // 3. הגדרת אירועים
            authForm.addEventListener('submit', function(e) {
                e.preventDefault();
                messageBox.classList.add('hidden'); // הסתר הודעה קודמת
                
                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();

                if (username.length === 0 || password.length === 0) {
                     displayMessage('שם משתמש וסיסמה אינם יכולים להיות ריקים.', 'error');
                     return;
                }

                if (isRegisterMode) {
                    handleRegister(username, password);
                } else {
                    handleLogin(username, password);
                }
            });

            switchModeButton.addEventListener('click', toggleMode);
            logoutButton.addEventListener('click', handleLogout);

            // 4. הצגת התצוגה הנכונה
            renderView();
        }

        // הפעלת האפליקציה לאחר טעינת כל האלמנטים
        window.onload = init;

    </script>
</body>
</html>