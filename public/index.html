<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת כניסה ורישום מקומית</title>
    <!-- טעינת Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* הגדרת פונט 'Inter' כברירת מחדל */
        body {
            font-family: 'Inter', sans-serif;
            
            /* --- הגדרות הרקע לתמונה (השינוי הקריטי) --- */
            /* ודא ש-intro.png הוא השם המדויק של הקובץ! */
            background-image: url('intro.png'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat; 
            background-attachment: fixed; 
            /* הסרת background-color: #f3f4f6; כדי שנוכל לראות את התמונה */
        }
        
        /* --- הגדרת כרטיסיית הכניסה (הוספת שקיפות ואפקטים) --- */
        #auth-container, #dashboard {
             /* הגדרת שקיפות קלה כך שהרקע יציץ מאחור */
             background-color: rgba(255, 255, 255, 0.90); 
             backdrop-filter: blur(8px); /* אפקט טשטוש חזק יותר */
             
             /* הוספת גבול וצל מותאמים אישית */
             border: 1px solid rgba(255, 255, 255, 0.4); 
             box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
             transition: all 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- שימו לב: הוסרו הקלאסים bg-white, shadow-2xl ו-border-gray-100 כדי לאפשר ל-CSS למעלה לשלוט ברקע השקוף -->
    <div id="auth-container" class="w-full max-w-md p-8 md:p-10 rounded-xl">

        <!-- כותרת האפליקציה -->
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2 text-center">
            כניסה
        </h1>
        <p class="text-gray-600 mb-8 text-center">
            השתמש במשתמשים השמורים באופן מקומי בדפדפן
        </p>

        <!-- הודעות מערכת -->
        <div id="message-box" class="mb-4 p-3 rounded-lg text-sm hidden" role="alert"></div>

        <!-- טופס כניסה / רישום -->
        <form id="auth-form" class="space-y-6">

            <!-- שדה שם משתמש -->
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700">שם משתמש</label>
                <input type="text" id="username" required 
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-right" 
                       placeholder="הזן שם משתמש">
            </div>

            <!-- שדה סיסמה -->
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">סיסמה</label>
                <input type="password" id="password" required 
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-right" 
                       placeholder="הזן סיסמה">
            </div>

            <!-- כפתור ראשי -->
            <div>
                <button type="submit" id="main-button" 
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    התחבר
                </button>
            </div>
        </form>

        <!-- מעבר בין מצבי רישום/כניסה -->
        <div class="mt-6 text-center">
            <button id="switch-mode-button" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium transition duration-150 ease-in-out">
                עדיין אין לך חשבון? הירשם
            </button>
        </div>
    </div>
	
		<!-- מסך בחירת צבע (בין Login ללובי) -->
	<div id="color-select-screen"
		 class="hidden flex flex-col items-center justify-center p-4"
		 style="min-height: 100vh;">

		<h1 class="text-3xl font-bold text-white mb-4">בחר צבע לטנק שלך</h1>

		<!-- כאן ימוקם גלגל הצבעים בשלב הבא -->
		<div id="color-wheel" class="relative w-64 h-64"></div>

		<p id="color-error" class="text-red-400 mt-4 hidden">עליך לבחור צבע</p>

		<button id="confirm-color-btn"
				class="mt-6 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg text-xl">
			המשך
		</button>
	</div>

	<!-- ====================== -->
	<!-- מסך לובי (מוחבא בהתחלה) -->
	<!-- ====================== -->

	

	<!-- מסך הלובי -->
	<div id="lobby-screen"
		 class="hidden flex flex-col items-center justify-between p-4 w-full h-full"
		 style="min-height: 100vh; background-size: cover; background-position: center;">

		<!-- אזור סטטיסטיקות (שמאל) -->
		<div class="absolute left-4 top-4 bg-white bg-opacity-80 p-4 rounded-lg shadow-lg text-black w-48">
			<h2 class="text-xl font-bold mb-2" id="lobby-username">שחקן</h2>

			<p class="text-md"><b>ניצחונות:</b> <span id="stat-wins">0</span></p>
			<p class="text-md"><b>הריגות:</b> <span id="stat-kills">0</span></p>
			<p class="text-md"><b>זמן משחק:</b> <span id="stat-time">0</span> שנ'</p>
		</div>

		<!-- כפתור PLAY (למטה ימין) -->
		<button id="play-btn"
				class="absolute bottom-10 right-10 px-10 py-5 text-2xl font-bold rounded-xl shadow-xl 
					   bg-gray-500 text-white cursor-not-allowed transition">
			מחכה לשחקנים...
		</button>

	</div>


    <!-- ממשק לאחר כניסה (Dashboard) -->
    <div id="dashboard" class="w-full max-w-md p-8 md:p-10 rounded-xl hidden">
        <h2 class="text-3xl font-extrabold text-gray-900 mb-4 text-center">
            ברוך הבא!
        </h2>
        <p class="text-gray-600 text-center mb-8">
            נכנסת בהצלחה למערכת המקומית.
        </p>
        
        <div class="bg-indigo-50 p-4 rounded-lg">
             <p class="text-lg font-semibold text-indigo-700 mb-2">פרטי המשתמש הנוכחי:</p>
             <p class="text-gray-800">שם משתמש: <span id="current-username" class="font-bold"></span></p>
             <p class="text-sm text-gray-500 mt-2">הנתונים שלך נשמרים ב-`localStorage` בדפדפן זה.</p>
        </div>

        <button id="logout-button" 
                class="mt-8 w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-base font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
            יציאה (Logout)
        </button>
    </div>

    <script>
        // הגדרת משתנים גלובליים
		let ws = null;

        let users = [];
        let isRegisterMode = false;
        let loggedInUser = null;

        // קבועים
        const USERS_STORAGE_KEY = 'local_auth_users';
        const SESSION_STORAGE_KEY = 'local_auth_session';

        // אלמנטים מה-DOM
        const authContainer = document.getElementById('auth-container');
        const dashboard = document.getElementById('dashboard');
        const authForm = document.getElementById('auth-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const mainButton = document.getElementById('main-button');
        const switchModeButton = document.getElementById('switch-mode-button');
        const logoutButton = document.getElementById('logout-button');
        const messageBox = document.getElementById('message-box');
        const currentUsernameSpan = document.getElementById('current-username');
        
        // --- פונקציות עזר ל-localStorage ---

        /**
         * טוען את רשימת המשתמשים מה-localStorage.
         */
        function loadUsers() {
            const usersJson = localStorage.getItem(USERS_STORAGE_KEY);
            try {
                users = usersJson ? JSON.parse(usersJson) : [];
            } catch (e) {
                console.error("שגיאה בטעינת משתמשים: ", e);
                users = []; // איפוס במקרה של שגיאת JSON
            }
            // Logging: הראה את רשימת המשתמשים שהתקבלה
            console.log("משתמשים שנטענו:", users);
        }

        /**
         * שומר את רשימת המשתמשים המעודכנת ל-localStorage.
         */
        function saveUsers() {
            localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
        }

        /**
         * מציג הודעת מערכת למשתמש.
         * @param {string} message - ההודעה להצגה.
         * @param {string} type - סוג ההודעה ('success', 'error', 'info').
         */
        function displayMessage(message, type) {
            messageBox.textContent = message;
            messageBox.className = "mb-4 p-3 rounded-lg text-sm"; // איפוס
            
            let classes = "";
            switch (type) {
                case 'success':
                    classes = "bg-green-100 border border-green-400 text-green-700";
                    break;
                case 'error':
                    classes = "bg-red-100 border border-red-400 text-red-700";
                    break;
                case 'info':
                default:
                    classes = "bg-blue-100 border border-blue-400 text-blue-700";
                    break;
            }
            messageBox.classList.remove('hidden');
            messageBox.classList.add(...classes.split(' '));
        }

        // --- לוגיקת כניסה ורישום ---

        /**
         * מחליף בין מצב כניסה (Login) למצב רישום (Register).
         */
        function toggleMode() {
            isRegisterMode = !isRegisterMode;

            if (isRegisterMode) {
                mainButton.textContent = "הרשם";
                switchModeButton.textContent = "כבר יש לך חשבון? התחבר";
                document.querySelector('h1').textContent = "רישום";
            } else {
                mainButton.textContent = "התחבר";
                switchModeButton.textContent = "עדיין אין לך חשבון? הירשם";
                document.querySelector('h1').textContent = "כניסה";
            }
            // נקה הודעות ושדות
            messageBox.classList.add('hidden');
            usernameInput.value = '';
            passwordInput.value = '';
        }

        /**
         * מטפל בתהליך הרישום.
         * @param {string} username - שם המשתמש.
         * @param {string} password - הסיסמה.
         */
        function handleRegister(username, password) {
            // בדיקה האם המשתמש כבר קיים
            const existingUser = users.find(u => u.username === username);
            if (existingUser) {
                displayMessage('שם משתמש זה כבר קיים. אנא בחר שם אחר.', 'error');
                return;
            }

            // הוספת משתמש חדש
            users.push({ username, password }); // הסיסמה נשמרת כטקסט רגיל!
            saveUsers();
            
            // מעבר אוטומטי למצב כניסה
            displayMessage('הרישום בוצע בהצלחה! אנא התחבר.', 'success');
            toggleMode();
        }

		/**
		 * מטפל בתהליך הכניסה.
		 * @param {string} username - שם המשתמש.
		 * @param {string} password - הסיסמה.
		 */
		function showColorSelectScreen() {
			authContainer.classList.add("hidden");
			dashboard.classList.add("hidden");

			const screen = document.getElementById("color-select-screen");
			screen.classList.remove("hidden");

			buildColorWheel(); // ← כאן
		}


		function handleLogin(username, password) {
			const user = users.find(u => u.username === username && u.password === password);

			if (!user) {
				displayMessage('שם משתמש או סיסמה שגויים.', 'error');
				return;
			}

			// שמירת session בדפדפן
			loggedInUser = username;
			localStorage.setItem(SESSION_STORAGE_KEY, username);

			displayMessage('התחברת בהצלחה!', 'success');

			// פותחים WebSocket רק עכשיו (אחרי התחברות)
			ws = new WebSocket("wss://tank-family-server.onrender.com/ws");

			ws.onopen = () => {
				console.log("WS connected!");
				setupWebSocketHandlers();   // רישום listeners
				showColorSelectScreen();    // מעבר למסך בחירת צבע
			};
		}



        /**
         * מטפל ביציאה מהמערכת.
         */
        function handleLogout() {
            loggedInUser = null;
            localStorage.removeItem(SESSION_STORAGE_KEY);
            displayMessage('יצאת מהמערכת.', 'info');
            renderView();
        }

        // --- ניהול תצוגה ---

        /**
         * מחליף את התצוגה בין טופס הכניסה/רישום ללוח הבקרה (Dashboard).
         */
        function renderView() {
            // הסתרת כל האלמנטים
            authContainer.classList.add('hidden');
            dashboard.classList.add('hidden');
            messageBox.classList.add('hidden');

            if (loggedInUser) {
                // הצג לוח בקרה
                dashboard.classList.remove('hidden');
                currentUsernameSpan.textContent = loggedInUser;
            } else {
                // הצג טופס אימות
                authContainer.classList.remove('hidden');
                authForm.reset();
            }
        }

        // --- אתחול והפעלת אירועים ---

        /**
         * טוען נתונים ומאתחל את האפליקציה.
         */
		function init() {

			// 1. טעינת נתוני המשתמשים
			loadUsers();

			// 2. בדיקת סשן קיים
			loggedInUser = localStorage.getItem(SESSION_STORAGE_KEY);

			// 3. הגדרת אירוע של טופס login/register
			authForm.addEventListener('submit', function(e) {
				e.preventDefault();
				messageBox.classList.add('hidden'); // הסתרת הודעה קודמת

				const username = usernameInput.value.trim();
				const password = passwordInput.value.trim();

				if (username.length === 0 || password.length === 0) {
					displayMessage('שם משתמש וסיסמה אינם יכולים להיות ריקים.', 'error');
					return;
				}

				if (isRegisterMode) {
					handleRegister(username, password);
				} else {
					handleLogin(username, password);  
					// ← כאן login יפתח WebSocket ויתקדם למסך בחירת צבע
				}
			});

			switchModeButton.addEventListener('click', toggleMode);
			logoutButton.addEventListener('click', handleLogout);

			// 4. הצגת התצוגה הנכונה
			renderView();
		}


        // הפעלת האפליקציה לאחר טעינת כל האלמנטים
        window.onload = init;
		
		// --- רשימת הצבעים האפשריים ---
		// חייב להתאים לרשימה בשרת!
		const COLOR_LIST = ["red","green","pink","blue","black","yellow"];

		// צבע שנבחר ע"י המשתמש
		let selectedColor = null;

		// בניית גלגל הצבעים
		function buildColorWheel() {
			const wheel = document.getElementById("color-wheel");
			wheel.innerHTML = ""; // ניקוי קודם

			COLOR_LIST.forEach(color => {
				const btn = document.createElement("div");
				btn.className =
					"w-16 h-16 rounded-full cursor-pointer border-4 border-white shadow-lg transition transform";
				btn.style.backgroundColor = color;

				btn.onclick = () => {
					selectedColor = color;

					// הסרת הדגשה מכל הצבעים
					document.querySelectorAll("#color-wheel div").forEach(b => {
						b.style.transform = "scale(1)";
						b.style.borderColor = "white";
					});

					// הדגשת הצבע שנבחר
					btn.style.transform = "scale(1.2)";
					btn.style.borderColor = "black";

					// הסתרת הודעת שגיאה אם הייתה
					document.getElementById("color-error").classList.add("hidden");
				};

				wheel.appendChild(btn);
			});
		}

		document.getElementById("confirm-color-btn").onclick = () => {
			if (!selectedColor) {
				document.getElementById("color-error").classList.remove("hidden");
				return;
			}

			ws.send(JSON.stringify({
				type: "join",
				username: loggedInUser,
				color: selectedColor
			}));
		};



		function showLobbyScreen(joinMsg) {
			// החביאו את כל שאר המסכים
			authContainer.classList.add("hidden");
			dashboard.classList.add("hidden");
			document.getElementById("color-select-screen").classList.add("hidden");

			const lobby = document.getElementById("lobby-screen");
			lobby.classList.remove("hidden");

			// 1. רקע הלובי לפי הצבע
			const color = joinMsg.color;          // הצבע שבחרת
			const bgPath = `loby_${color}.png`;   // לדוגמה: loby_red.png

			lobby.style.backgroundImage = `url('${bgPath}')`;

			// 2. סטטיסטיקות לידי שמאל
			document.getElementById("lobby-username").textContent = joinMsg.name;
			document.getElementById("stat-wins").textContent = joinMsg.stats.wins;
			document.getElementById("stat-kills").textContent = joinMsg.stats.kills;
			document.getElementById("stat-time").textContent = Math.floor(joinMsg.stats.play_time);

			// 3. שמירת ה-ID של השחקן
			window.PLAYER_ID = joinMsg.id;
			window.PLAYER_COLOR = joinMsg.color;

			// 4. ניהול כפתור PLAY
			const playBtn = document.getElementById("play-btn");
			playBtn.disabled = true; 
			playBtn.style.cursor = "not-allowed";
			playBtn.textContent = "מחכה לשחקנים...";

			// שליחת בקשה להתחיל משחק רק אם יש מספיק שחקנים
			playBtn.onclick = () => {
				ws.send(JSON.stringify({ type: "request_start_game" }));
			};

			// 5. נתחיל לקלוט lobby_state מהשרת (זה יופיע ב ws.onmessage)
		}

		// כל הודעה שמגיעה מהשרת תעבור כאן
		function setupWebSocketHandlers() {

			ws.onmessage = (event) => {
				const msg = JSON.parse(event.data);
				console.log("WS message:", msg);

				// 1. אישור הצטרפות (JOINED)
				if (msg.type === "joined") {
					showLobbyScreen(msg);
				}

				// 2. עדכון לובי
				if (msg.type === "lobby_state") {
					updateLobbyUI(msg);
				}

				// 3. תחילת משחק
				if (msg.type === "start_game") {
					console.log("GAME START!", msg);
					// כאן בהמשך תעבור למסך המשחק עצמו
				}

				// 4. הודעת שגיאה
				if (msg.type === "error") {
					alert(msg.message);
				}
			};
		}


		function updateLobbyUI(state) {
			const playBtn = document.getElementById("play-btn");
			const num = state.num_players;

			if (num < 2) {
				playBtn.disabled = true;
				playBtn.textContent = "מחכה לשחקנים...";
				playBtn.style.backgroundColor = "gray";
				return;
			}

			playBtn.disabled = false;
			playBtn.textContent = "PLAY";
			playBtn.style.backgroundColor = "green";
		}

		// -------- WebSocket --------


		
    </script>
</body>
</html>