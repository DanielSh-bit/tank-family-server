<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Tank Family</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #333;
            font-family: sans-serif;
            touch-action: none; /* מונע גלילה בטלפון */
            user-select: none; /* מונע סימון טקסט */
        }
        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
        /* מסך טעינה */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-align: center;
        }
        /* כפתורי שליטה למסך מגע */
        .controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            height: 150px;
            pointer-events: none; /* כדי שאפשר יהיה לראות דרכם */
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
        }
        .dpad, .fire-btn {
            pointer-events: auto; /* מחזיר אינטראקציה לכפתורים */
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            backdrop-filter: blur(4px);
        }
        .dpad {
            width: 120px;
            height: 120px;
            position: relative;
        }
        .fire-btn {
            width: 80px;
            height: 80px;
            margin-top: 20px;
            background: rgba(255, 50, 50, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }
        .fire-btn:active {
            background: rgba(255, 50, 50, 0.6);
        }
        /* הסטיק הפנימי */
        #stick {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>

    <div id="loading">מתחבר לשרת...</div>
    <canvas id="gameCanvas"></canvas>

    <div class="controls">
        <div class="dpad" id="dpad">
            <div id="stick"></div>
        </div>
        <div class="fire-btn" id="fireBtn">אש</div>
    </div>

    <script>
        // --- הגדרות ---
        // הכתובת של השרת שלך ב-Render
        const SERVER_URL = "wss://tank-family-server.onrender.com"; 
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const loading = document.getElementById('loading');
        
        // משתני משחק
        let socket;
        let myId = null;
        let gameState = null;
        
        // משתני שליטה (Input)
        let input = { x: 0, y: 0 };
        let isFiring = false;

        // התאמת הקנבס לגודל המסך
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- חיבור לשרת ---
        function connect() {
            socket = new WebSocket(SERVER_URL);

            socket.onopen = () => {
                console.log("Connected!");
                loading.innerText = "מחובר! מחפש משחק...";
                // שליחת בקשת הצטרפות
                socket.send(JSON.stringify({ type: "join", name: "MobileTank" }));
            };

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);

                if (msg.type === 'joined') {
                    myId = msg.id;
                    loading.style.display = 'none';
                    console.log("Joined as " + msg.color);
                }
                
                if (msg.type === 'state') {
                    gameState = msg;
                }

                if (msg.type === 'error') {
                    alert("שגיאה: " + msg.reason);
                }
            };

            socket.onclose = () => {
                loading.style.display = 'block';
                loading.innerText = "החיבור נותק. מנסה שוב...";
                setTimeout(connect, 3000);
            };
        }

        // --- לולאת המשחק (שליחה וציור) ---
        function gameLoop() {
            // 1. שליחת פקודות לשרת (אם מחוברים)
            if (socket && socket.readyState === WebSocket.OPEN && myId) {
                socket.send(JSON.stringify({
                    type: "input",
                    dir: input,
                    fire: isFiring
                }));
            }

            // 2. ציור המסך
            draw();

            requestAnimationFrame(gameLoop);
        }

        function draw() {
            // ניקוי מסך
            ctx.fillStyle = "#222";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (!gameState) return;

            // המצלמה עוקבת אחרי השחקן שלי
            let camX = 0, camY = 0;
            if (myId && gameState.players[myId]) {
                const me = gameState.players[myId];
                camX = canvas.width / 2 - me.x;
                camY = canvas.height / 2 - me.y;
            }

            ctx.save();
            ctx.translate(camX, camY);

            // ציור גבולות עולם (סתם בשביל אוריינטציה)
            ctx.strokeStyle = "#444";
            ctx.strokeRect(0, 0, 2000, 2000); 

            // ציור שחקנים
            for (let pid in gameState.players) {
                const p = gameState.players[pid];
                if (!p.alive) continue;

                ctx.save();
                ctx.translate(p.x, p.y);
                
                // גוף הטנק
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(0, 0, 15, 0, Math.PI * 2);
                ctx.fill();

                // קו מתאר (צהוב אם זה אני)
                if (pid === myId) {
                    ctx.strokeStyle = "yellow";
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }

                // תותח (מסתובב לפי הזווית)
                ctx.rotate(p.angle);
                ctx.fillStyle = "black";
                ctx.fillRect(0, -3, 25, 6);

                ctx.restore();
                
                // שם השחקן
                ctx.fillStyle = "white";
                ctx.font = "12px Arial";
                ctx.textAlign = "center";
                ctx.fillText(p.name, p.x, p.y - 25);
            }

            ctx.restore();
        }

        // --- טיפול במגע (ג'ויסטיק וירטואלי) ---
        const dpad = document.getElementById('dpad');
        const stick = document.getElementById('stick');
        const fireBtn = document.getElementById('fireBtn');

        let dpadCenter = { x: 0, y: 0 };

        // עדכון מיקום הג'ויסטיק
        function updateJoystick(touchX, touchY) {
            const maxDist = 40; // רדיוס תנועה
            let dx = touchX - dpadCenter.x;
            let dy = touchY - dpadCenter.y;
            
            const distance = Math.sqrt(dx*dx + dy*dy);
            
            // נרמול ל-1.0
            let normX = dx;
            let normY = dy;

            if (distance > maxDist) {
                const ratio = maxDist / distance;
                dx *= ratio;
                dy *= ratio;
            }
            
            // הזזת הויזואלית של הסטיק
            stick.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;

            // עדכון הקלט למשחק (בין -1 ל 1)
            input.x = dx / maxDist;
            input.y = dy / maxDist;
        }

        // אירועי מגע לג'ויסטיק
        dpad.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = dpad.getBoundingClientRect();
            dpadCenter = { 
                x: rect.left + rect.width / 2, 
                y: rect.top + rect.height / 2 
            };
            updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
        }, {passive: false});

        dpad.addEventListener('touchmove', (e) => {
            e.preventDefault();
            updateJoystick(e.touches[0].clientX, e.touches[0].clientY);
        }, {passive: false});

        dpad.addEventListener('touchend', (e) => {
            e.preventDefault();
            stick.style.transform = `translate(-50%, -50%)`; // איפוס ויזואלי
            input.x = 0;
            input.y = 0; // איפוס תנועה
        });

        // כפתור ירי
        fireBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            isFiring = true;
        }, {passive: false});

        fireBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            isFiring = false;
        });

        // התחלה
        connect();
        gameLoop();

    </script>
</body>
</html>